# -*- coding: utf-8 -*-
"""Materiais.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/12Qxp6EAGWt-S6qEphtKRoKpTJsmLTh9v
"""

# =========================================================
# CEMINAS - GERADOR DE RELA√á√ÉO DE MATERIAIS
# Interface Web Interativa (Streamlit Cloud)
# ---------------------------------------------------------
# Autor: Ellen Lousada / Engenharia Ceminas
# Vers√£o: 2025.11 (Deploy Cloud - Corre√ß√µes persistentes)
# =========================================================

import streamlit as st
import pandas as pd
import os
from io import BytesIO

# ---------------------------------------------------------
# CONFIGURA√á√ÉO DE P√ÅGINA E ESTILO VISUAL
# ---------------------------------------------------------
st.set_page_config(page_title="Ceminas - Lista de Materiais", page_icon="‚ö°", layout="centered")

st.markdown("""
    <style>
        .main { background-color: #E6F0FF; } /* azul claro */
        .title { text-align: center; font-size: 36px; font-weight: 800; color: #003366; margin-top: 10px; }
        .subtitle { text-align: center; font-size: 18px; color: #333; margin-bottom: 30px; }
        .stButton>button { background-color: #003366; color: #fff; font-weight: 700; border-radius: 8px; padding: .6em 1.2em; }
        .stButton>button:hover { background-color: #0059b3; color: #fff; }
    </style>
""", unsafe_allow_html=True)

# ---------------------------------------------------------
# LOGOTIPO
# ---------------------------------------------------------
logo_path = "Logo Ceminas.jpeg"
if os.path.exists(logo_path):
    st.image(logo_path, use_column_width=False, width=250)
else:
    st.warning("‚ö†Ô∏è Logotipo n√£o encontrado no diret√≥rio do app (Logo Ceminas.jpeg).")

st.markdown('<div class="title">CEMINAS ‚Äì Gerador de Rela√ß√£o de Materiais</div>', unsafe_allow_html=True)
st.markdown('<div class="subtitle">Ferramenta interna para consolida√ß√£o de materiais de redes de distribui√ß√£o</div>', unsafe_allow_html=True)
st.divider()

# ---------------------------------------------------------
# AUTENTICA√á√ÉO B√ÅSICA (SENHA)
# ---------------------------------------------------------
senha_correta = "Ceminas2025"
if "auth" not in st.session_state:
    st.session_state["auth"] = False

if not st.session_state["auth"]:
    senha = st.text_input("üîê Digite a senha de acesso:", type="password")
    if senha == senha_correta:
        st.session_state["auth"] = True
        st.success("Acesso liberado! ‚úÖ")
        st.rerun()
    else:
        st.stop()

# ---------------------------------------------------------
# UPLOAD DO ARQUIVO E PROCESSAMENTO
# ---------------------------------------------------------
st.header("üì§ Enviar planilha de estruturas do projeto")
uploaded_file = st.file_uploader("Envie o arquivo **EstruturasProjeto.xlsx**", type=["xlsx"])

banco_estruturas = "MateriaisEstrutura.xlsx"  # Banco principal no reposit√≥rio

if uploaded_file is not None:
    st.success("‚úÖ Arquivo recebido com sucesso!")
    projeto_path = "EstruturasProjeto.xlsx"
    with open(projeto_path, "wb") as f:
        f.write(uploaded_file.read())

    st.divider()
    st.header("üèóÔ∏è Configura√ß√£o da Obra")
    obra = st.text_input("Nome da obra:", "Nova Obra")
    obra_limpa = "".join(c for c in obra if c.isalnum() or c in (" ", "-", "_")).strip()
    arquivo_saida = f"Ceminas - Materiais - {obra_limpa}.xlsx"

    gerar = st.button("‚öôÔ∏è Gerar Rela√ß√£o de Materiais")

    if gerar:
        try:
            # ------------------ Leitura e normaliza√ß√£o ------------------
            estruturas = pd.read_excel(banco_estruturas, engine="openpyxl")
            projeto = pd.read_excel(projeto_path, engine="openpyxl")

            for df in [estruturas, projeto]:
                df.columns = df.columns.str.strip().str.upper()
                for col in df.select_dtypes(include=["object"]).columns:
                    df[col] = df[col].astype(str).str.strip().str.upper()

            # ------------------ Checagem de combina√ß√µes ------------------
            keys = ["ESTRUTURA", "EQUIPAMENTO", "CONDUTOR", "POSTE"]
            chaves_banco = estruturas[keys].drop_duplicates()
            chaves_proj = projeto[keys].drop_duplicates()

            faltantes = (
                chaves_proj.merge(chaves_banco, on=keys, how="left", indicator=True)
                .query('_merge == "left_only"')
                .drop(columns="_merge")
            )

            # Preparar session_state para escolhas
            if "correcoes_choices" not in st.session_state:
                st.session_state["correcoes_choices"] = {}

            correcoes = {}

            if not faltantes.empty:
                st.warning(f"‚ö†Ô∏è Foram encontradas {len(faltantes)} combina√ß√µes inexistentes no banco.")
                st.markdown("Selecione abaixo como tratar cada uma:")

                with st.form("corrigir_faltantes", clear_on_submit=False):
                    for i, row in faltantes.reset_index(drop=True).iterrows():
                        estrutura = row["ESTRUTURA"]
                        equipamento = row["EQUIPAMENTO"]
                        condutor = row["CONDUTOR"]
                        poste = row["POSTE"]

                        st.markdown(
                            f"**‚ùå Estrutura:** {estrutura} | **Equipamento:** {equipamento} | **Condutor:** {condutor} | **Poste:** {poste}"
                        )

                        sugestoes = (
                            estruturas[estruturas["ESTRUTURA"] == estrutura][["EQUIPAMENTO", "CONDUTOR", "POSTE"]]
                            .drop_duplicates()
                            .reset_index(drop=True)
                        )

                        if sugestoes.empty:
                            st.info("üîπ Nenhuma varia√ß√£o cadastrada dessa estrutura ‚Äî ela ser√° ignorada.")
                            continue

                        opcoes = ["Ignorar esta estrutura"] + [
                            f"{r['EQUIPAMENTO']} | {r['CONDUTOR']} | {r['POSTE']}"
                            for _, r in sugestoes.iterrows()
                        ]

                        key_sel = f"choice_{estrutura}_{equipamento}_{condutor}_{poste}_{i}"
                        default_val = st.session_state["correcoes_choices"].get(key_sel, opcoes[0])

                        escolha = st.selectbox(
                            f"Selecione uma alternativa para {estrutura}:",
                            options=opcoes,
                            key=key_sel,
                            index=opcoes.index(default_val) if default_val in opcoes else 0,
                        )

                        # Persistir a escolha no estado
                        st.session_state["correcoes_choices"][key_sel] = escolha
                        st.divider()

                    submitted = st.form_submit_button("‚úÖ Aplicar Corre√ß√µes e Gerar Rela√ß√£o")

                # Se o formul√°rio foi submetido, montar o dicion√°rio de corre√ß√µes
                if not faltantes.empty and submitted:
                    for i, row in faltantes.reset_index(drop=True).iterrows():
                        estrutura = row["ESTRUTURA"]
                        equipamento = row["EQUIPAMENTO"]
                        condutor = row["CONDUTOR"]
                        poste = row["POSTE"]
                        key_sel = f"choice_{estrutura}_{equipamento}_{condutor}_{poste}_{i}"
                        escolha = st.session_state["correcoes_choices"].get(key_sel, "Ignorar esta estrutura")

                        if escolha != "Ignorar esta estrutura":
                            eq, cond, pst = [x.strip() for x in escolha.split("|")]
                            correcoes[(estrutura, equipamento, condutor, poste)] = {
                                "EQUIPAMENTO": eq, "CONDUTOR": cond, "POSTE": pst
                            }
                    # ap√≥s montar corre√ß√µes, seguimos para gera√ß√£o
                elif not faltantes.empty and not submitted:
                    st.stop()
            else:
                st.success("‚úÖ Todas as combina√ß√µes do projeto est√£o no banco de dados.")

            # ------------------ Aplicar corre√ß√µes ------------------
            projeto_corrigido = projeto.copy()
            if correcoes:
                for idx, row in projeto.iterrows():
                    chave = (row["ESTRUTURA"], row["EQUIPAMENTO"], row["CONDUTOR"], row["POSTE"])
                    if chave in correcoes:
                        novo = correcoes[chave]
                        projeto_corrigido.loc[idx, ["EQUIPAMENTO", "CONDUTOR", "POSTE"]] = [
                            novo["EQUIPAMENTO"], novo["CONDUTOR"], novo["POSTE"]
                        ]

                # (opcional) Mostrar resumo das corre√ß√µes aplicadas
                resumo = []
                for (est, eq, cond, pst), novo in correcoes.items():
                    resumo.append({
                        "ESTRUTURA": est,
                        "EQUIPAMENTO_ORIG": eq,
                        "CONDUTOR_ORIG": cond,
                        "POSTE_ORIG": pst,
                        "EQUIPAMENTO_NOVO": novo["EQUIPAMENTO"],
                        "CONDUTOR_NOVO": novo["CONDUTOR"],
                        "POSTE_NOVO": novo["POSTE"],
                    })
                if resumo:
                    st.info("üßæ Corre√ß√µes aplicadas:")
                    st.dataframe(pd.DataFrame(resumo), use_container_width=True)

            # ------------------ Consolida√ß√£o final ------------------
            materiais_lista = []
            for _, row in projeto_corrigido.iterrows():
                flt = (
                    (estruturas["ESTRUTURA"] == row["ESTRUTURA"]) &
                    (estruturas["EQUIPAMENTO"] == row["EQUIPAMENTO"]) &
                    (estruturas["CONDUTOR"] == row["CONDUTOR"]) &
                    (estruturas["POSTE"] == row["POSTE"])
                )
                encontrados = estruturas.loc[flt].copy()
                if not encontrados.empty:
                    encontrados["QTD_PROJETO"] = row["QUANTIDADE"]
                    materiais_lista.append(encontrados)

            if materiais_lista:
                materiais = pd.concat(materiais_lista, ignore_index=True)
                materiais["QTD_TOTAL"] = materiais["QUANTIDADE"] * materiais["QTD_PROJETO"]

                relacao = (
                    materiais.groupby(["CODIGO", "DESCRI√á√ÉO", "UNIDADE"], as_index=False)["QTD_TOTAL"]
                    .sum()
                    .sort_values("DESCRI√á√ÉO")
                )

                buffer = BytesIO()
                relacao.to_excel(buffer, index=False)
                st.success(f"‚úÖ Rela√ß√£o consolidada gerada com sucesso para {obra}")
                st.download_button(
                    label="üì• Baixar planilha gerada",
                    data=buffer.getvalue(),
                    file_name=arquivo_saida,
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
            else:
                st.warning("‚ö†Ô∏è Nenhuma estrutura v√°lida encontrada para gera√ß√£o da rela√ß√£o.")

        except Exception as e:
            st.error(f"‚ùå Ocorreu um erro: {e}")
