# -*- coding: utf-8 -*-
"""Materiais.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/12Qxp6EAGWt-S6qEphtKRoKpTJsmLTh9v
"""

# =========================================================
# CEMINAS - GERADOR DE RELAÇÃO DE MATERIAIS
# Interface Web Interativa (Streamlit Cloud)
# ---------------------------------------------------------
# Autor: Ellen Lousada / Engenharia Ceminas
# Versão: 2025.11 (Deploy Cloud)
# =========================================================

import streamlit as st
import pandas as pd
import os
from io import BytesIO

# ---------------------------------------------------------
# CONFIGURAÇÃO DE PÁGINA E ESTILO VISUAL
# ---------------------------------------------------------
st.set_page_config(page_title="Ceminas - Lista de Materiais", page_icon="⚡", layout="centered")

# Cabeçalho estilizado
st.markdown("""
    <style>
        .main {
            background-color: #f8f9fa;
        }
        .title {
            text-align: center;
            font-size: 34px;
            font-weight: 700;
            color: #003366;
        }
        .subtitle {
            text-align: center;
            font-size: 18px;
            color: #666;
        }
        .stButton>button {
            background-color: #003366;
            color: white;
            font-weight: bold;
            border-radius: 8px;
            padding: 0.6em 1.2em;
        }
        .stButton>button:hover {
            background-color: #0059b3;
            color: white;
        }
    </style>
""", unsafe_allow_html=True)

st.markdown('<div class="title">⚡ Ceminas – Gerador de Relação de Materiais</div>', unsafe_allow_html=True)
st.markdown('<div class="subtitle">Ferramenta interna para consolidação de materiais de redes de distribuição</div>', unsafe_allow_html=True)

st.divider()

# ---------------------------------------------------------
# AUTENTICAÇÃO BÁSICA (SENHA)
# ---------------------------------------------------------
senha_correta = "Ceminas2025"

if "auth" not in st.session_state:
    st.session_state["auth"] = False

if not st.session_state["auth"]:
    senha = st.text_input("Digite a senha de acesso:", type="password")
    if senha == senha_correta:
        st.session_state["auth"] = True
        st.success("Acesso liberado!")
        st.experimental_rerun()
    else:
        st.stop()

# ---------------------------------------------------------
# UPLOAD DO ARQUIVO E PROCESSAMENTO
# ---------------------------------------------------------
st.header("Enviar planilha de estruturas do projeto")

uploaded_file = st.file_uploader("Envie o arquivo **EstruturasProjeto.xlsx**", type=["xlsx"])

banco_estruturas = "MateriaisEstrutura.xlsx"  # Deve estar no mesmo repositório ou pasta

if uploaded_file is not None:
    st.success("Arquivo recebido com sucesso!")

    # Salva o arquivo temporariamente
    projeto_path = "EstruturasProjeto.xlsx"
    with open(projeto_path, "wb") as f:
        f.write(uploaded_file.read())

    st.divider()
    st.header("Configuração da Obra")

    obra = st.text_input("Nome da obra:", "Nova Obra")
    obra_limpa = "".join(c for c in obra if c.isalnum() or c in (" ", "-", "_")).strip()
    arquivo_saida = f"Ceminas - Materiais - {obra_limpa}.xlsx"

    gerar = st.button("Gerar Relação de Materiais")

    if gerar:
        try:
            # -------------------------------------------------
            # Leitura das planilhas
            # -------------------------------------------------
            estruturas = pd.read_excel(banco_estruturas, engine="openpyxl")
            projeto = pd.read_excel(projeto_path, engine="openpyxl")

            # Padroniza colunas
            for df in [estruturas, projeto]:
                df.columns = df.columns.str.strip().str.upper()
                for col in df.select_dtypes(include=["object"]).columns:
                    df[col] = df[col].astype(str).str.strip().str.upper()

            # -------------------------------------------------
            # Geração da relação consolidada
            # -------------------------------------------------
            materiais_lista = []
            for _, row in projeto.iterrows():
                filtro = (
                    (estruturas["ESTRUTURA"] == row["ESTRUTURA"]) &
                    (estruturas["EQUIPAMENTO"] == row["EQUIPAMENTO"]) &
                    (estruturas["CONDUTOR"] == row["CONDUTOR"]) &
                    (estruturas["POSTE"] == row["POSTE"])
                )
                encontrados = estruturas.loc[filtro].copy()
                if not encontrados.empty:
                    encontrados["QTD_PROJETO"] = row["QUANTIDADE"]
                    materiais_lista.append(encontrados)

            if materiais_lista:
                materiais = pd.concat(materiais_lista, ignore_index=True)
                materiais["QTD_TOTAL"] = materiais["QUANTIDADE"] * materiais["QTD_PROJETO"]

                relacao = (
                    materiais.groupby(["CODIGO", "DESCRIÇÃO", "UNIDADE"], as_index=False)["QTD_TOTAL"]
                    .sum()
                    .sort_values("DESCRIÇÃO")
                )

                # -------------------------------------------------
                # Download do arquivo
                # -------------------------------------------------
                buffer = BytesIO()
                relacao.to_excel(buffer, index=False)
                st.success(f"Relação consolidada gerada para: {obra}")
                st.download_button(
                    label="Baixar planilha gerada",
                    data=buffer.getvalue(),
                    file_name=arquivo_saida,
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )

            else:
                st.warning("Nenhuma estrutura válida encontrada no banco de dados.")

        except Exception as e:
            st.error(f"Ocorreu um erro: {e}")